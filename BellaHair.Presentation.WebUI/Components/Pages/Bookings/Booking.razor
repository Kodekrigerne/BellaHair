<!-- Dennis -->

@page "/booking/new"
@page "/booking/{Id}"
@page "/booking/{Id}/rediger"

@rendermode InteractiveServer

@using BellaHair.Ports.Employees
@using BellaHair.Ports.PrivateCustomers
@using BellaHair.Ports.Treatments
@using BellaHair.Presentation.WebUI.Components.Pages.Employees
@using BellaHair.Presentation.WebUI.Components.Pages.PrivateCustomers
@using BellaHair.Presentation.WebUI.Components.Pages.Treatments

@inject IPrivateCustomerQuery CustomerQuery;
@inject ITreatmentQuery TreatmentQuery;
@inject IEmployeeQuery EmployeeQuery;

<div class="kk-container body-container">
	<div class="body-left">
		<div class="left-container">
			<div class="pick-container">
				@if (Customer == null)
				{
					<button class="btn-pick" @onclick="HandlePickCustomerClick">Vælg en kunde</button>
				}
				else
				{
					<button @onclick="HandleChangeCustomerClick">@Customer.FullName</button>
				}
			</div>
			<div class="pick-container">
				@if (Treatment == null)
				{
					<button class="btn-pick" @onclick="HandlePickTreatmentClick">Vælg en behandling</button>
				}
				else
				{
					<button @onclick="HandleChangeTreatmentClick">@Treatment.Name</button>
				}
			</div>
		</div>
		<div class="left-container">
			<div class="pick-container">
				@if (Employee == null)
				{
					<button class="btn-pick" @onclick="HandlePickEmployeeClick">Vælg en Medarbejder</button>
				}
				else
				{
					<button @onclick="HandleChangeEmployeeClick">@Employee.Name</button>
				}
			</div>
			<div class="pick-container">
				@if (StartDateTime == null)
				{
					<button class="btn-pick" @onclick="HandlePickStartDateTimeClick">Vælg en tid</button>
				}
				else
				{
					<p @onclick="HandleChangeTimeClick">@StartDateTime</p>
				}
			</div>
		</div>
	</div>
	<div class="body-right">
		<div class="right-picker">
			@if (_activePicker == Picker.Customers)
			{
				@foreach (var customer in _customers)
				{
					<button @onclick="() => HandleCustomerPickerClick(customer.Id)">@customer.FullName</button>
				}
			}
			else if (_activePicker == Picker.Treatments)
			{
				@foreach (var treatment in _treatments)
				{
					<button @onclick="() => HandleTreatmentPickerClick(treatment.Id)">@treatment.Name</button>
				}
			}
			else if (_activePicker == Picker.Employee)
			{
				@foreach (var employee in _employees)
				{
					<button @onclick="() => HandleEmployeePickerClick(employee.Id)">@employee.Name</button>
				}
			}
			else if (_activePicker == Picker.Time)
			{
				<p>Pick a time</p>
			}
		</div>
		<div class="right-buttons"></div>
	</div>
</div>

@code {
	private enum Picker { None, Customers, Treatments, Employee, Time }
	private Picker _activePicker = Picker.None;

	[Parameter]
	public Guid Id { get; set; }

	public PrivateCustomerViewModel? Customer { get; set; }
	public TreatmentViewModel? Treatment { get; set; }
	public EmployeeNameWithBookingsViewModel? Employee { get; set; }
	public DateTime? StartDateTime { get; set; }

	private List<PrivateCustomerViewModel> _customers = [];
	private List<TreatmentViewModel> _treatments = [];
	private List<EmployeeNameWithBookingsViewModel> _employees = [];

	private async Task HandlePickCustomerClick()
	{
		_customers = (await CustomerQuery.GetPrivateCustomersAsync())
		.Select(e => new PrivateCustomerViewModel(e.Id, e.FullName, e.Birthday, e.Email, e.PhoneNumber, e.FullAddress, e.Visists)).ToList();

		_activePicker = Picker.Customers;

	}

	private async Task HandlePickTreatmentClick()
	{
		if (Customer == null) return;

		_treatments = (await TreatmentQuery.GetAllAsync())
		.Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration, t.EmployeeCount)).ToList();

		_activePicker = Picker.Treatments;
	}

	private async Task HandlePickEmployeeClick()
	{
		if (Treatment == null) return;

		_employees = (await EmployeeQuery.GetHasTreatmentAndWithFutureBookingsAsync(Treatment.Id))
			.Select(e => new EmployeeNameWithBookingsViewModel(
				e.Id,
				e.Name,
				e.Bookings
					.Select(b => new BookingTimesOnlyViewModel(b.StartDateTime, b.StartDateTime.AddMinutes(b.DurationMinutes)))
					.ToList()))
			.ToList();

		_activePicker = Picker.Employee;
	}

	private async Task HandlePickStartDateTimeClick()
	{
		if (Employee == null) return;

		await Task.Delay(1);
		_activePicker = Picker.Time;
	}

	private async Task HandleCustomerPickerClick(Guid customerId)
	{
		Customer = _customers.Find(c => c.Id == customerId);
		await HandlePickTreatmentClick();
	}

	private async Task HandleTreatmentPickerClick(Guid treatmentId)
	{
		Treatment = _treatments.Find(t => t.Id == treatmentId);
		await HandlePickEmployeeClick();
	}

	private async Task HandleEmployeePickerClick(Guid employeeId)
	{
		Employee = _employees.Find(t => t.Id == employeeId);
		await HandlePickStartDateTimeClick();
	}

	private void HandleChangeCustomerClick()
	{
		Customer = null;
		Treatment = null;
		Employee = null;
		StartDateTime = null;

		_activePicker = Picker.Customers;
	}

	private void HandleChangeTreatmentClick()
	{
		Treatment = null;
		Employee = null;
		StartDateTime = null;

		_activePicker = Picker.Treatments;
	}

	private void HandleChangeEmployeeClick()
	{
		Employee = null;
		StartDateTime = null;

		_activePicker = Picker.Employee;
	}

	private void HandleChangeTimeClick()
	{
		StartDateTime = null;

		_activePicker = Picker.Time;
	}
}

<style>
	.body-container {
		display: flex;
		flex-direction: row;
		padding: 1rem;
	}

	.body-left {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.left-container {
		display: flex;
		flex-direction: row;
		gap: 10px;
	}

	.pick-container {
		flex: 1;
		border-style: solid;
		border-width: 1px;
		border-radius: 6px;
		display: flex;
	}

	.btn-pick {
		border: none;
		background:none;
		flex: 1;
	}

	.body-right {
		flex: 1;
	}

	.right-picker {
		display: flex;
		flex-direction: column;
	}
</style>
