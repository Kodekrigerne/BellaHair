<!-- Dennis -->

@page "/booking/new"
@page "/booking/{Id}"
@page "/booking/{Id}/rediger"

@rendermode InteractiveServer

@using BellaHair.Ports.Bookings
@using BellaHair.Ports.Employees
@using BellaHair.Ports.PrivateCustomers
@using BellaHair.Ports.Treatments
@using BellaHair.Presentation.WebUI.Components.Pages.Employees
@using BellaHair.Presentation.WebUI.Components.Pages.PrivateCustomers
@using BellaHair.Presentation.WebUI.Components.Pages.Treatments

@inject IPrivateCustomerQuery CustomerQuery;
@inject ITreatmentQuery TreatmentQuery;
@inject IEmployeeQuery EmployeeQuery;
@inject IBookingQuery BookingQuery;

<div class="kk-container">
	<div class="body-container">
		<div class="body-left">
			<div class="left-container">
				<div class="pick-container">
					@if (Customer == null)
					{
						<button class="btn-pick" @onclick="HandlePickCustomerClick">Vælg en kunde</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeCustomerClick">
							<p class="picked-label">Kunde</p>
							<p class="picked-text">@Customer.FullName</p>
						</button>
					}
				</div>
				<div class="pick-container">
					@if (Treatment == null)
					{
						<button class="btn-pick @(Customer == null ? "inactive" : "")" @onclick="HandlePickTreatmentClick">Vælg en behandling</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeTreatmentClick">
							<p class="picked-label">Behandling</p>
							<p class="picked-text">@Treatment.Name</p>
						</button>
					}
				</div>
			</div>
			<div class="left-container">
				<div class="pick-container">
					@if (Employee == null)
					{
						<button class="btn-pick @(Treatment == null ? "inactive" : "")" @onclick="HandlePickEmployeeClick">Vælg en Medarbejder</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeEmployeeClick">
							<p class="picked-label">Medarbejder</p>
							<p class="picked-text">@Employee.Name</p>
						</button>
					}
				</div>
				<div class="pick-container">
					@if (StartDate == null && StartTime == null)
					{
						<button class="btn-pick @(Employee == null ? "inactive" : "")" @onclick="HandlePickStartDateTimeClick">Vælg en tid</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeTimeClick">
							<p class="picked-label">Dato og tid</p>
							<p class="picked-text">@StartDate @StartTime</p>
						</button>
					}
				</div>
			</div>
		</div>
		<div class="body-right">
			<div class="right-picker">
				@if (_activePicker == Picker.Customers)
				{
					@foreach (var customer in _customers)
					{
						<button class="picker-btn" @onclick="() => HandleCustomerPickerClick(customer.Id)">@customer.FullName</button>
					}
				}
				else if (_activePicker == Picker.Treatments)
				{
					@foreach (var treatment in _treatments)
					{
						<button class="picker-btn" @onclick="() => HandleTreatmentPickerClick(treatment.Id)">@treatment.Name</button>
					}
				}
				else if (_activePicker == Picker.Employee)
				{
					if (Employee == null)
					{
						@foreach (var employee in _employees)
						{
							<button class="picker-btn" @onclick ="() => HandleEmployeePickerClick(employee.Id)">@employee.Name</button>
						}
					}
				}
				else if (_activePicker == Picker.Time && Employee != null)
				{
					<p>Vælg en dato</p>
					<input @ref="_dateRef" type="date" value="StartDate" @onchange="HandleDateChanged"/>
					<p>Vælg en tid</p>
					<input @ref="_timeRef" type="time" value="StartTime" @onchange="HandleTimeChanged" />
				}
			</div>
			@if (_timeIsAvailable != null) {
				<div class="right-bottom">
					@if (_timeIsAvailable.Value) { <p>Denne tid er ledig</p> }
					else { <p>Denne tid er allerede booket</p> }
					<button @onclick="HandleCreateBookingClick">Book denne tid</button>
				</div>
			}
		</div>
	</div>
</div>

@code {
	private enum Picker { None, Customers, Treatments, Employee, Time }
	private Picker _activePicker = Picker.None;

	[Parameter]
	public Guid Id { get; set; }

	public PrivateCustomerViewModel? Customer { get; set; }
	public TreatmentViewModel? Treatment { get; set; }
	public EmployeeNameWithBookingsViewModel? Employee { get; set; }
	public DateOnly? StartDate { get; set; }
	public TimeOnly? StartTime { get; set; }
	private bool? _timeIsAvailable;

	private ElementReference _dateRef;
	private ElementReference _timeRef;

	private List<PrivateCustomerViewModel> _customers = [];
	private List<TreatmentViewModel> _treatments = [];
	private List<EmployeeNameWithBookingsViewModel> _employees = [];

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		await HandlePickCustomerClick();
	}

	private async Task HandlePickCustomerClick()
	{
		_customers = (await CustomerQuery.GetPrivateCustomersAsync())
		.Select(e => new PrivateCustomerViewModel(e.Id, e.FullName, e.Birthday, e.Email, e.PhoneNumber, e.FullAddress, e.Visists))
		.OrderBy(e => e.FullName)
		.ToList();

		_activePicker = Picker.Customers;

	}

	private async Task HandlePickTreatmentClick()
	{
		if (Customer == null) return;

		_treatments = (await TreatmentQuery.GetAllAsync())
		.Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration, t.EmployeeCount))
		.OrderBy(t => t.Name)
		.ToList();

		_activePicker = Picker.Treatments;
	}

	private async Task HandlePickEmployeeClick()
	{
		if (Treatment == null) return;

		_employees = (await EmployeeQuery.GetHasTreatmentAndWithFutureBookingsAsync(Treatment.Id))
			.Select(e => new EmployeeNameWithBookingsViewModel(
				e.Id,
				e.Name,
				e.Bookings
					.Select(b => new BookingTimesOnlyViewModel(b.StartDateTime, b.StartDateTime.AddMinutes(b.DurationMinutes)))
					.ToList()))
			.OrderBy(e => e.Name)
			.ToList();

		_activePicker = Picker.Employee;
	}

	private void HandlePickStartDateTimeClick()
	{
		if (Employee == null) return;

		_activePicker = Picker.Time;
	}

	private async Task HandleCustomerPickerClick(Guid customerId)
	{
		Customer = _customers.Find(c => c.Id == customerId);
		await HandlePickTreatmentClick();
	}

	private async Task HandleTreatmentPickerClick(Guid treatmentId)
	{
		Treatment = _treatments.Find(t => t.Id == treatmentId);
		await HandlePickEmployeeClick();
	}

	private void HandleEmployeePickerClick(Guid employeeId)
	{
		Employee = _employees.Find(t => t.Id == employeeId);
		HandlePickStartDateTimeClick();
	}

	private async Task HandleDateChanged(ChangeEventArgs cea)
	{
		StartDate = DateOnly.Parse((string)cea.Value!);

		if (StartTime != null)
		{
			await HandleDateTimeChanged();
		}
	}

	private async Task HandleTimeChanged(ChangeEventArgs cea)
	{
		StartTime = TimeOnly.Parse((string)cea.Value!);

		if (StartDate != null)
		{
			await HandleDateTimeChanged();
		}
	}

	private async Task HandleDateTimeChanged()
	{
		var dateTime = new DateTime(StartDate!.Value.Year, StartDate.Value.Month, StartDate.Value.Day, StartTime!.Value.Hour, StartTime.Value.Minute, StartTime.Value.Second);
		var query = new BookingIsAvailableQuery(dateTime, Treatment!.DurationMinutes, Employee!.Id, Customer!.Id);

		_timeIsAvailable = !(await BookingQuery.BookingIsAvailable(query));
	}

	private async Task HandleCreateBookingClick()
	{
		
	}

	private void HandleChangeCustomerClick()
	{
		Customer = null;
		Treatment = null;
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;

		_activePicker = Picker.Customers;
	}

	private void HandleChangeTreatmentClick()
	{
		Treatment = null;
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;

		_activePicker = Picker.Treatments;
	}

	private void HandleChangeEmployeeClick()
	{
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;

		_activePicker = Picker.Employee;
	}

	private void HandleChangeTimeClick()
	{
		StartDate = null;
		StartDate = null;
		_timeIsAvailable = null;

		_activePicker = Picker.Time;
	}
}

<style>
	.body-container {
		display: flex;
		flex-direction: row;
		padding: 0rem;
		flex: 1;
		gap: 1rem;
	}

	.body-left {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.left-container {
		display: flex;
		flex-direction: row;
		gap: 10px;
	}

	.pick-container {
		flex: 1;
		border-style: solid;
		border-width: 1px;
		border-radius: 6px;
		display: flex;
		height: 4rem;
	}

	.btn-pick {
		border: none;
		background:none;
		flex: 1;
		border-radius: 6px;
		background-color: white;
		font-size: 1.05rem;
		font-weight: 600;
	}

		.btn-pick:hover {
			background-color: #f0f4fa;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			cursor: pointer;
			transition: background 0.2s, box-shadow 0.2s;
		}

		.btn-pick.inactive {
			background-color: lightgrey;
		}

	.btn-picked {
		border: none;
		background: none;
		flex: 1;
		border-radius: 6px;
		background-color: white;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

		.btn-picked:hover {
			background-color: #f0f4fa;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			cursor: pointer;
			transition: background 0.1s, box-shadow 0.1s;
		}

	.picked-label {
		margin: 0;
		font-size: 1.05rem;
		font-weight: 600;
	}

	.picked-text {
		margin: 0;
		font-size: 1.10rem;
		font-weight: 700;
	}

	.body-right {
		flex: 1;
	}

	.right-picker {
		display: flex;
		flex-direction: column;
		height: 20rem;
		border-style: solid;
		border-width: 1px;
		border-color: black;
		border-radius: 6px;
		overflow-x: auto;
		overflow-y: scroll;
	}

	.picker-btn {
		display: block;
		width: 100%;
		padding: 12px 20px;
		margin: 0;
		border: none;
		border-bottom: 1px solid #eee;
		background: none;
		text-align: center;
		font-size: 1rem;
		color: #222;
		transition: background 0.1s, color 0.1s;
	}

		.picker-btn:last-child {
			border-bottom: none;
		}

		.picker-btn:hover,
		.picker-btn:focus {
			background: #e3eafb;
			color: #1d4ed8;
			outline: none;
		}

		.picker-btn:active {
			background: #dbeafe;
		}
</style>
