<!-- Dennis -->

@page "/booking/new"
@page "/booking/{Id}"
@page "/booking/{Id}/rediger"

@rendermode InteractiveServer

@using BellaHair.Domain
@using BellaHair.Infrastructure
@using BellaHair.Ports.Bookings
@using BellaHair.Ports.Discounts
@using BellaHair.Ports.Employees
@using BellaHair.Ports.PrivateCustomers
@using BellaHair.Ports.Treatments
@using BellaHair.Presentation.WebUI.Components.Pages.Employees
@using BellaHair.Presentation.WebUI.Components.Pages.PrivateCustomers
@using BellaHair.Presentation.WebUI.Components.Pages.Treatments

@inject ISnackbar Snackbar;
@inject IPrivateCustomerQuery CustomerQuery;
@inject ITreatmentQuery TreatmentQuery;
@inject IEmployeeQuery EmployeeQuery;
@inject IBookingQuery BookingQuery;
@inject IBookingCommand BookingCommand;
@inject IDiscountQuery DiscountQuery;
@inject NavigationManager NavigationManager;
@inject ICurrentDateTimeProvider CurrentDateTimeProvider;

<div class="kk-container">
	<div class="body-container">
		<div class="body-left">
			<div class="left-container">
				<div class="pick-container">
					@if (Customer == null)
					{
						<button class="btn-pick" @onclick="HandlePickCustomerClick">Vælg en kunde</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeCustomerClick">
							<p class="picked-label">Kunde</p>
							<p class="picked-text">@Customer.FullName</p>
						</button>
					}
				</div>
				<div class="pick-container">
					@if (Treatment == null)
					{
						<button class="btn-pick @(Customer == null ? "inactive" : "")" @onclick="HandlePickTreatmentClick">Vælg en behandling</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeTreatmentClick">
							<p class="picked-label">Behandling</p>
							<p class="picked-text">
								<span class="picked-name">@Treatment.Name</span>
								<span class="picked-duration">@Treatment.DurationMinutes min</span>
							</p>
						</button>
					}
				</div>
			</div>
			<div class="left-container">
				<div class="pick-container">
					@if (Employee == null)
					{
						<button class="btn-pick @(Treatment == null ? "inactive" : "")" @onclick="HandlePickEmployeeClick">Vælg en Medarbejder</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeEmployeeClick">
							<p class="picked-label">Medarbejder</p>
							<p class="picked-text">@Employee.Name</p>
						</button>
					}
				</div>
				<div class="pick-container">
					@if (StartDate == null && StartTime == null)
					{
						<button class="btn-pick @(Employee == null ? "inactive" : "")" @onclick="HandlePickStartDateTimeClick">Vælg en tid</button>
					}
					else
					{
						<button class="btn-picked" @onclick="HandleChangeTimeClick">
							<p class="picked-label">Dato og tid</p>
							<p class="picked-text">@StartDate!.Value.Date @StartTime</p>
						</button>
					}
				</div>
			</div>
		</div>
		<div class="body-right">
			<div class="right-picker">
				@if (_activePicker == Picker.Customers)
				{
					@foreach (var customer in _customers)
					{
						<button class="picker-btn" @onclick="() => HandleCustomerPickerClick(customer.Id)">@customer.FullName</button>
					}
				}
				else if (_activePicker == Picker.Treatments)
				{
					@foreach (var treatment in _treatments)
					{
						<button class="picker-btn" @onclick="() => HandleTreatmentPickerClick(treatment.Id)">
							<span class="treatment-name">@treatment.Name</span>
							<span class="treatment-duration">@treatment.DurationMinutes min</span>
						</button>
					}
				}
				else if (_activePicker == Picker.Employee)
				{
					if (Employee == null)
					{
						@foreach (var employee in _employees)
						{
							<button class="picker-btn" @onclick ="() => HandleEmployeePickerClick(employee.Id)">@employee.Name</button>
						}
					}
				}
				else if (_activePicker == Picker.Time && Employee != null)
				{
					<p>Vælg en dato</p>
					<MudDatePicker
						@ref="_datePickerRef"
						Date="StartDate"
						DateChanged="HandleDateChanged"
						PickerVariant="PickerVariant.Dialog"
						IsDateDisabledFunc="@(dt => dt.Date < _now.Date || dt.DayOfWeek == DayOfWeek.Saturday || dt.DayOfWeek == DayOfWeek.Sunday)" />
					<p>Vælg en tid</p>
					<MudTimePicker
						@ref="_timePickerRef"
						Time="StartTime"
						MinuteSelectionStep="5"
						TimeChanged="HandleTimeChanged"
						PickerVariant = "PickerVariant.Dialog"/>
				}
			</div>
			@if (_timeIsAvailable != null)
			{
				<div class="right-bottom">
					<p class="availability-status">@_availabilityMessage</p>

					@if (_timeIsAvailable != null && _timeIsAvailable == true) {
					<div class="discount-section">
						<button class="btn-discount" @onclick="HandleGetDiscountClick">Hent bedste rabat</button>
						@if (_discount != null)
						{
							<p class="discount-name">Rabat: @_discount.Name</p>
							<p class="discount-amount">Beløb: @_discount.Amount.ToString("F2") dkk</p>
						}
					</div>

					<div class="price-section">
						<p class="price-without-discount">Pris uden rabat: @Treatment!.Price.ToString("F2") dkk</p>
						@if (_discount != null)
						{
							<p class="price-with-discount">Pris med rabat: @((Treatment!.Price - _discount.Amount).ToString("F2")) dkk</p>
						}
					</div>

					<button class="btn-create" @onclick="HandleCreateBookingClick">Book denne tid</button>
					}
				</div>
			}
		</div>
	</div>
</div>

@code {
	private enum Picker { None, Customers, Treatments, Employee, Time }
	private Picker _activePicker = Picker.None;

	private DateTime _now;
	private MudDatePicker? _datePickerRef;
	private MudTimePicker? _timePickerRef;

	[Parameter]
	public Guid Id { get; set; }

	public PrivateCustomerViewModel? Customer { get; set; }
	public TreatmentViewModel? Treatment { get; set; }
	public EmployeeNameWithBookingsViewModel? Employee { get; set; }

	public DateTime? StartDate { get; set; }

	public TimeSpan? StartTime { get; set; }

	private bool? _timeIsAvailable;
	private string? _availabilityMessage;

	private BookingDiscountViewModel? _discount;

	private List<PrivateCustomerViewModel> _customers = [];
	private List<TreatmentViewModel> _treatments = [];
	private List<EmployeeNameWithBookingsViewModel> _employees = [];

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		_now = CurrentDateTimeProvider.GetCurrentDateTime();
		await HandlePickCustomerClick();
	}

	private async Task HandlePickCustomerClick()
	{
		_customers = (await CustomerQuery.GetPrivateCustomersAsync())
		.Select(e => new PrivateCustomerViewModel(e.Id, e.FullName, e.Birthday, e.Email, e.PhoneNumber, e.FullAddress, e.Visists))
		.OrderBy(e => e.FullName)
		.ToList();

		_activePicker = Picker.Customers;

	}

	private async Task HandlePickTreatmentClick()
	{
		if (Customer == null) return;

		_treatments = (await TreatmentQuery.GetAllAsync())
		.Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration, t.EmployeeCount))
		.OrderBy(t => t.Name)
		.ToList();

		_activePicker = Picker.Treatments;
	}

	private async Task HandlePickEmployeeClick()
	{
		if (Treatment == null) return;

		_employees = (await EmployeeQuery.GetHasTreatmentAndWithFutureBookingsAsync(Treatment.Id))
			.Select(e => new EmployeeNameWithBookingsViewModel(
				e.Id,
				e.Name,
				e.Bookings
					.Select(b => new BookingTimesOnlyViewModel(b.StartDateTime, b.StartDateTime.AddMinutes(b.DurationMinutes)))
					.ToList()))
			.OrderBy(e => e.Name)
			.ToList();

		_activePicker = Picker.Employee;
	}

	private async Task HandlePickStartDateTimeClick()
	{
		if (Employee == null) return;

		if (_now.DayOfWeek == DayOfWeek.Saturday) StartDate = _now.Date.AddDays(2);
		else if (_now.DayOfWeek == DayOfWeek.Sunday) StartDate = _now.Date.AddDays(1);
		else StartDate = _now;

		_activePicker = Picker.Time;
		StateHasChanged();
		//Det er nødvendigt at un-batche state changes her så DatePickeren bliver vist før vi kalder Open på den.
		await Task.Delay(1);
		if (_datePickerRef != null) {
			await _datePickerRef.OpenAsync();
		}
	}

	private async Task HandleCustomerPickerClick(Guid customerId)
	{
		Customer = _customers.Find(c => c.Id == customerId);
		await HandlePickTreatmentClick();
	}

	private async Task HandleTreatmentPickerClick(Guid treatmentId)
	{
		Treatment = _treatments.Find(t => t.Id == treatmentId);
		await HandlePickEmployeeClick();
	}

	private async Task HandleEmployeePickerClick(Guid employeeId)
	{
		Employee = _employees.Find(t => t.Id == employeeId);
		await HandlePickStartDateTimeClick();
	}

	private async Task HandleDateChanged(DateTime? newDate)
	{
		if (newDate == null) return;

		StartDate = newDate;

		if (StartTime != null)
		{
			await HandleDateTimeChanged();
		}
		else
		{
			if (_timePickerRef != null) await _timePickerRef.OpenAsync();
		}
	}

	private async Task HandleTimeChanged(TimeSpan? newTime)
	{
		if (newTime == null) return;

		StartTime = newTime;

		if (StartDate != null)
		{
			await HandleDateTimeChanged();
		}
	}

	private async Task HandleDateTimeChanged()
	{
		if (StartDate == null || StartTime == null) return;

		var startDateTime = StartDate.Value.Add(StartTime!.Value);
		var treatmentEnd = startDateTime.AddMinutes(Treatment!.DurationMinutes);

		var date = StartDate.Value.Date;
		var earliest = date.AddHours(10);
		var latest = date.AddHours(18);

		if (startDateTime < earliest)
		{
			_timeIsAvailable = false;
			_availabilityMessage = "Kan ikke starte booking før åbningstid";
			return;
		}

		if (treatmentEnd > latest)
		{
			_timeIsAvailable = false;
			_availabilityMessage = "Booking skal slutte før lukketid";
			return;
		}

		var query = new BookingIsAvailableQuery(startDateTime, Treatment!.DurationMinutes, Employee!.Id, Customer!.Id);

		_timeIsAvailable = !(await BookingQuery.BookingIsAvailable(query));
		_availabilityMessage = _timeIsAvailable == true ? "Denne tid er ledig" : "Denne tid er ikke ledig";
	}

	private async Task HandleCreateBookingClick()
	{
		if (!_timeIsAvailable!.Value || StartDate == null || StartTime == null) return;

		var startDateTime = StartDate.Value.Add(StartTime.Value);
		var command = new CreateBookingCommand(startDateTime, Employee!.Id, Customer!.Id, Treatment!.Id);

		try
		{
			await BookingCommand.CreateBooking(command);
			Snackbar.Add("Booking blev oprettet.", Severity.Success);
			NavigationManager.NavigateTo("/bookings");
		}
		catch (DomainException ex) { Snackbar.Add(ex.Message, Severity.Error); }
		catch { Snackbar.Add("Noget gik galt.", Severity.Error); }
	}

	private void HandleChangeCustomerClick()
	{
		Customer = null;
		Treatment = null;
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;
		_discount = null;
		_availabilityMessage = null;

		_activePicker = Picker.Customers;
	}

	private void HandleChangeTreatmentClick()
	{
		Treatment = null;
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;
		_discount = null;
		_availabilityMessage = null;

		_activePicker = Picker.Treatments;
	}

	private void HandleChangeEmployeeClick()
	{
		Employee = null;
		StartDate = null;
		StartTime = null;
		_timeIsAvailable = null;
		_discount = null;
		_availabilityMessage = null;

		_activePicker = Picker.Employee;
	}

	private void HandleChangeTimeClick()
	{
		StartDate = null;
		StartDate = null;
		_timeIsAvailable = null;
		_discount = null;
		_availabilityMessage = null;

		_activePicker = Picker.Time;
	}

	private async Task HandleGetDiscountClick(MouseEventArgs args)
	{
		if (StartDate == null || StartTime == null) return;

		try
		{
			var startDateTime = StartDate.Value.Add(StartTime.Value);
			var query = new FindBestDiscountQuery(startDateTime, Employee!.Id, Customer!.Id, Treatment!.Id);

			var discountDTO = await DiscountQuery.FindBestDiscount(query);
			if (discountDTO == null) Snackbar.Add("Fandt ingen rabat", Severity.Warning);
			_discount = discountDTO == null ? null : new BookingDiscountViewModel(discountDTO.Name, discountDTO.Amount);
		}
		catch
		{
			Snackbar.Add("Der opstod en fejl ved hentning af rabat", Severity.Error);
		}
	}
}

<style>
	.body-container {
		display: flex;
		flex-direction: row;
		padding: 0rem;
		flex: 1;
		gap: 1rem;
	}

	.body-left {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.left-container {
		display: flex;
		flex-direction: row;
		gap: 10px;
	}

	.pick-container {
		flex: 1;
		border-style: solid;
		border-width: 1px;
		border-radius: 6px;
		display: flex;
		height: 4rem;
	}

	.btn-pick {
		border: none;
		background:none;
		flex: 1;
		border-radius: 6px;
		background-color: white;
		font-size: 1.05rem;
		font-weight: 600;
	}

		.btn-pick:hover {
			background-color: #f0f4fa;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			cursor: pointer;
			transition: background 0.2s, box-shadow 0.2s;
		}

		.btn-pick.inactive {
			background-color: lightgrey;
		}

	.btn-picked {
		border: none;
		background: none;
		flex: 1;
		border-radius: 6px;
		background-color: white;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

		.btn-picked:hover {
			background-color: #f0f4fa;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			cursor: pointer;
			transition: background 0.1s, box-shadow 0.1s;
		}

	.picked-label {
		margin: 0;
		font-size: 1.05rem;
		font-weight: 600;
	}

	.picked-text {
		margin: 0;
		font-size: 1.10rem;
		font-weight: 700;
	}

	.picked-duration {
		position: absolute;
		right: 0.8rem;
		font-size: 0.97em;
		opacity: 0.76;
		pointer-events: none;
		padding-left: 6px;
	}

	.body-right {
		flex: 1;
	}

	.right-picker {
		display: flex;
		flex-direction: column;
		height: 20rem;
		border-style: solid;
		border-width: 1px;
		border-color: black;
		border-radius: 6px;
		overflow-x: auto;
		overflow-y: scroll;
	}

	.picker-btn {
		position: relative;
		display: block;
		width: 100%;
		padding: 12px 20px;
		margin: 0;
		border: none;
		border-bottom: 1px solid #eee;
		background: none;
		text-align: center;
		font-size: 1rem;
		color: #222;
		transition: background 0.1s, color 0.1s;
	}

	.treatment-duration {
		position: absolute;
		right: 20px;
		top: 50%;
		transform: translateY(-50%);
		opacity: 0.7;
		font-size: 0.95em;
		pointer-events: none;
	}

		.picker-btn:last-child {
			border-bottom: none;
		}

		.picker-btn:hover,
		.picker-btn:focus {
			background: #e3eafb;
			color: #1d4ed8;
			outline: none;
		}

		.picker-btn:active {
			background: #dbeafe;
		}

	.right-bottom {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	/* Line 1: Availability status */
	.availability-status {
		margin: 0;
		font-weight: 600;
		font-size: 1rem;
	}

	/* Line 2: Discount section */
	.discount-section {
		display: flex;
		align-items: center;
		gap: 12px;
		flex-wrap: wrap;
	}

	.btn-discount {
		padding: 8px 16px;
		background-color: #4CAF50;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.9rem;
		font-weight: 500;
	}

		.btn-discount:hover {
			background-color: #45a049;
		}

	.discount-name {
		margin: 0;
		font-size: 0.9rem;
	}

	.discount-amount {
		margin: 0;
		font-size: 0.9rem;
		font-weight: 600;
	}

	/* Line 3: Price section */
	.price-section {
		display: flex;
		gap: 16px;
		flex-wrap: wrap;
	}

	.price-without-discount {
		margin: 0;
		font-size: 0.9rem;
	}

	.price-with-discount {
		margin: 0;
		font-size: 0.9rem;
		font-weight: 600;
		color: #4CAF50;
	}

	/* Line 4: Create booking button */
	.btn-create {
		padding: 12px 24px;
		background-color: #2196F3;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 1rem;
		font-weight: 600;
		transition: background-color 0.3s ease;
	}

		.btn-create:hover {
			background-color: #0b7dda;
		}
</style>
