@attribute [StreamRendering]
@using BellaHair.Domain
@using BellaHair.Ports.Treatments
@using BellaHair.Presentation.WebUI.Components.Shared

<!-- Mikkel Klitgaard -->

@page "/behandlinger"

@rendermode InteractiveServer
@inject ITreatmentQuery TreatmentQuery
@inject ITreatmentCommand TreatmentCommand
@inject ISnackbar Snackbar

<Modal @bind-IsVisible="@_showNewModal">

	<TreatmentModalForm OnCreate="@LoadTreatments" OnCancel="@CloseModal"/>

</Modal>

<Modal @bind-IsVisible="@_showOfferedByModal">

	<TreatmentOfferedByModal TreatmentId="@_selectedTreatmentId"
        OnClose="@(() => { _showOfferedByModal = false; })"/>
	
	</Modal>

<PageHeader HeaderText="Behandlinger" 
	HeaderSubText="Alle tilgængelige behandlinger" 
	NewButtonText="Ny behandling" 
	OnNewButtonClicked= "@(() => { _showNewModal = true; })" />

<div class="kk-container treatment-container">

	@if (_treatments == null) { <p>Loading...</p> }
	else {
			@foreach (var treatment in _treatments)
			{
			<TreatmentCard Treatment="treatment" 
                OnDelete="@LoadTreatments" 
                OnShowOfferedBy="@(() => { _showOfferedByModal = true; _selectedTreatmentId = treatment.Id; })"/>
			}
	}
	</div>


@code {
    private bool _showNewModal = false;
    private bool _showOfferedByModal = false;

    private Guid _selectedTreatmentId;
    private List<TreatmentViewModel>? _treatments = null;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await LoadTreatments();
    }

    private async Task LoadTreatments()
    {
        _showNewModal = false;

        try
        {
            var treatments = await TreatmentQuery.GetAllAsync();
            _treatments = treatments
                .OrderBy(t => t.Name)
                .Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration, t.EmployeeCount))
                .ToList();
        }
        catch (DomainException dex)
        {
            Snackbar.Add(dex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Der skete en fejl under indlæsningen af behandlingerne: {ex.Message}", Severity.Error);
        }
    }


    private void CloseModal()
    {
	    _showNewModal = false;
	    Snackbar.Add("Handlingen blev annulleret.", Severity.Info);
    }

}

