@attribute [StreamRendering]
@using BellaHair.Domain
@using BellaHair.Ports.Treatments
@using BellaHair.Presentation.WebUI.Components.Shared


@page "/behandlinger"

@rendermode InteractiveServer
@inject ITreatmentQuery _treatmentQuery


<PageHeader HeaderText="Behandlinger" HeaderSubText="Alle tilgængelige behandlinger" NewButtonText="Ny behandling" OnNewButtonClicked="@(() => { })" />

	<div class="kk-container employees-container">
	@if (_errorMessage != null) { <p>@_errorMessage</p> }
	@if (_treatments == null) { <p>Loading...</p> }
	else {
			@foreach (var treatment in _treatments)
			{
			<div class="employee-card">

				<div class="employee-avatar">
					<TreatmentIcon Class="treatment-icon"/>
				</div>

				<div class="treatment-details">

					<h6>@treatment.Name</h6>

					<hr class="treatment-line"/>

					<div class="price-duration-wrapper">

						<div class="employee-contact-details">

							<PriceIcon Class="treatment-price-icon"/>
							@treatment.Price.ToString("C")

						</div>

						<div class="employee-contact-details">
							<DurationIcon Class="treatment-duration-icon"/>
							@treatment.DurationMinutes min

						</div>
					</div>
				</div>
			</div>
			}
	}
	</div>








@code {
	private string? _errorMessage;
	private List<TreatmentViewModel>? _treatments = null;


	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		await LoadTreatments();
	}

	private async Task LoadTreatments()
	{
		try
		{
			var treatments = await _treatmentQuery.GetAllAsync();
			_treatments = treatments
				.OrderBy(t => t.Name)
				.Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration))
				.ToList();
		}
		catch (DomainException dex)
		{
			_errorMessage = dex.Message;
		}
		catch (Exception ex)
		{
			_errorMessage = $"Der skete en fejl under indlæsning af behandlinger: {ex.Message}";
		}
	}

record TreatmentViewModel(Guid Id, string Name, decimal Price, int DurationMinutes);


}

