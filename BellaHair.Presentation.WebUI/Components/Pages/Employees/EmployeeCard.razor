@using BellaHair.Ports.Employees
@using BellaHair.Presentation.WebUI.Components.Shared;
@inject IEmployeeCommand _employeeCommand
@inject IEmployeeQuery _employeeQuery
@inject ISnackbar SnackBar


		<Modal @bind-IsVisible="@_showNewModal">
			<div class="modal-centered-content">
				<DeleteConfirmationIcon Class="delete-confirmation-icon"/>
			@if (_futureBookings)
			{
				<p style="max-width: 22rem; text-align: center;"> Medarbejderen @employeeSimpleViewModel.Name har fremtidige bookinger.
					Disse skal slettes før medarbejderen 
				</p>
			<button class="btn-add" onclick="@CloseModal">Annuller</button>

			}

			else
			{
				<h4>Slet: @employeeSimpleViewModel.Name?</h4>
				<p style="max-width: 22rem; text-align: center;">Er du sikker på, at du vil slette denne medarbejder?
			Denne handling kan ikke fortrydes.
				</p>
				<div class="remove-confirmation-buttons">
				<button class="btn-remove" onclick="@HandleOnDeleteConfirm">Ja, slet</button>
				<button class="btn-add" onclick="@CloseModal">Annuller</button>
			</div>
			}
			</div>
		</Modal>


		<div class="employee-card">														@*Contains the entire singular employee card layout*@
						
				<div class="employee-avatar">											@*Contains the avatar with intials*@
					@GetEmployeeInitials(@employeeSimpleViewModel.Name)
				</div>
					<div>																@*Positions other info to position next to avatar*@
					<h3>@employeeSimpleViewModel.Name</h3>

						<div class="employee-contact-details">
							<div class="employee-single-contact-detail">
								<MailIcon Class="employee-icons" />
									@employeeSimpleViewModel.Email
								</div>

							<div class="employee-single-contact-detail">
								<PhoneIcon Class="employee-icons"/>
									@employeeSimpleViewModel.PhoneNumber
							</div>
						</div>
			<div class="delete-button">
						<BinDeleteButton OnClick="@HandleOnDeleteClick"/>
			</div>
						<div class="treatments-employees-container">					@*Contains all treatments and makes it possible to position them together*@
						@foreach (var treatment in employeeSimpleViewModel.TreatmentNames)
							{															
								<div class="treatment-employee-card">@treatment</div>	@*Contains individual treatment and their layout*@
							}
						</div>
					</div>
				</div>

@code
{
	private bool _showNewModal = false;
	private bool _futureBookings = false;

	[Parameter, EditorRequired]
	public required EmployeeSimpleViewModel employeeSimpleViewModel { get; set; }

	[Parameter, EditorRequired]
	public required EventCallback<Guid> OnDelete { get; set; }

	/// <summary>
	/// Provides initials needed to make employee avatar by taking a full name as a single string,
	///  splitting it into separate words (parts) based on spaces, and returns the first letter of
	///  each word concatenated into a single string.
	/// </summary>
	/// <param name="name"></param>
	private string GetEmployeeInitials(string name)
	{
		var parts = name.Split(' ');
		return string.Concat(parts.Select(p => p.FirstOrDefault()));

	}

	private async Task HandleOnDeleteClick()
	{
		_showNewModal = true;
		_futureBookings = await _employeeQuery.EmployeeFutureBookingsCheck(employeeSimpleViewModel.Id);
	}

	private async Task HandleOnDeleteConfirm()
	{
		var command = new DeleteEmployeeCommand(employeeSimpleViewModel.Id);
		try
		{
			await _employeeCommand.DeleteEmployeeCommand(command);
			CloseModal();
			SnackBar.Add("Medarbejderen blev slettet.", Severity.Success);
			await OnDelete.InvokeAsync(employeeSimpleViewModel.Id);
		}
		catch (Exception e)
		{
			SnackBar.Add(e.Message, Severity.Warning);
		}
	}

	private void CloseModal() => _showNewModal = false;

}
