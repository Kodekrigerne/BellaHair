@using BellaHair.Ports.Treatments
@using System.Linq.Expressions
@using BellaHair.Presentation.WebUI.Components.Pages.Treatments
@using BellaHair.Presentation.WebUI.Components.Shared
@inherits InputBase<List<Guid>>

<div class="inputs-items-container kk-container" style="border-radius: 8px">
    <h5 style="margin-top: 2px; text-align: center">Vælg behandlinger</h5>

    <div style="height: 300px; overflow-y: scroll;">
        <br />

        <div class="treatments-container">
            @if (Treatments == null || !Treatments.Any())
            {
                <p style="padding: 10px; color: grey;">Ingen behandlinger fundet...</p>
            }
            else
            {
                @foreach (var treatment in Treatments)
                {
                    bool isSelected = CurrentValue != null && CurrentValue.Contains(treatment.Id);

                    string itemStyle = isSelected
                    ? "border: 2px solid #990dff; background-color: #f6e6fc; color: black; position: relative; cursor: pointer;"
                    : "border: 2px solid lightgrey; background-color: white; color: black; position: relative; cursor: pointer;";

                    @* We make the whole DIV clickable (@onclick).
                       We also use @key to help Blazor track the list items efficiently.
                    *@

                    <div @key="treatment.Id"
                         @onclick="() => ToggleSelection(treatment.Id)"
                         class="treatment-item"
                         style="@itemStyle;">

                        <div style="display: flex; justify-content: space-between; align-items: center;">

                            <p style="font-weight: bold; color: #2b2b2b">@treatment.Name</p>

                            <!-- Custom Icon (Optional) -->
						<div>
								@if (isSelected)
								{
									<CheckedCirle/>
								}
								else
								{
									<UncheckedCircle/>
								}
							</div>

                        </div>

                        <div class="d-flex align-items-start" style="gap: 2rem">

                            <div class="treatment-icon-format">
                                <DurationIcon Class="treatment-list-icon" /> <p class="treatment-text">@treatment.DurationMinutes min</p>
                            </div>

                            <div class="treatment-icon-format">
                               <PriceIcon Class="treatment-list-icon"/> <p class="treatment-text">@treatment.Price.ToString("C")</p>
                            </div>
                        </div>
                </div>


                }
            }
        </div>
    </div>

    <ValidationMessage For="@ValueExpression" />
</div>

@code {
    [Parameter, EditorRequired]
    public List<TreatmentViewModel> Treatments { get; set; } = new();

    private async Task ToggleSelection(Guid treatmentId)
    {
        // 1. Ensure the list exists
        if (CurrentValue == null)
        {
            CurrentValue = new List<Guid>();
        }

        // 2. Modify the list
        if (CurrentValue.Contains(treatmentId))
        {
            CurrentValue.Remove(treatmentId);
        }
        else
        {
            CurrentValue.Add(treatmentId);
        }

        // 3. Notify EditForm (Validation)
        EditContext.NotifyFieldChanged(FieldIdentifier);

        // 4. Notify Parent Component (Binding)
        // This ensures the parent's model is explicitly updated in the binding system
        await ValueChanged.InvokeAsync(CurrentValue);
    }

    protected override bool TryParseValueFromString(string? value, out List<Guid> result, out string? validationErrorMessage)
    {
        // This method is required by InputBase but not used for List<Guid>.
        result = CurrentValue ?? new List<Guid>();
        validationErrorMessage = null;
        return true;
    }
}