@using BellaHair.Presentation.WebUI.Components.Pages.Treatments
@using BellaHair.Presentation.WebUI.Components.Shared
@using System.Collections.Generic;
@using System.ComponentModel.DataAnnotations;
@using System.Linq;
@using BellaHair.Ports.Employees
@using BellaHair.Ports.Treatments
@using MudBlazor
@inject IEmployeeCommand _employeeCommand
@inject ITreatmentQuery _treatmentQuery

<h3 style="text-align: center">Opret ny medarbejder</h3>

<EditForm Model="@_newEmployeeModel" OnValidSubmit="@HandleCreateEmployee">
        <DataAnnotationsValidator />

		<div class="inputs-container">
		<div class="inputs-items-container">
		@if (_errorMessage != null)
		{
			<p>@_errorMessage</p>
		}

		<div class="kk-container">
				<h5 style="margin-top: 2px;">Personligt info</h5>
				<div class="employee-grouped-inputs"
		<div class="employee-input">
    <label for="first-name-input" class="required">Fornavn</label>
				<input id="first-name-input" type="text" @bind="_newEmployeeModel.FirstName" style="width: 150px" />
			<ValidationMessage For="@(() => _newEmployeeModel.FirstName)" />
		</div>

		<div class="employee-input">
	<label for="middle-name-input">Mellemnavn</label>
	<input id="middle-name-input" type="text" @bind="_newEmployeeModel.MiddleName" style="width: 150px"/>
	<ValidationMessage For="@(() => _newEmployeeModel.MiddleName)" />
		</div>

				<div class="employee-input">
				<label for="last-name-input" class="required">Efternavn</label>
				<input id="last-name-input" type="text" @bind="_newEmployeeModel.LastName" style="width: 150px" />
	<ValidationMessage For="@(() => _newEmployeeModel.LastName)" />
		</div>
		</div>

		<div class="employee-grouped-inputs">
				<div class="employee-input">
	<label for="email-input" class="required">Email</label>
	<input id="email-input" type="text" @bind="_newEmployeeModel.Email" />
	<ValidationMessage For="@(() => _newEmployeeModel.Email)" />
		</div>

				<div class="employee-input">
				<label for="phonenumber-input" class="required">Telefon</label>
	<input id="phonenumber-input" type="number" @bind="_newEmployeeModel.PhoneNumber" style="width: 100px; "/>
	<ValidationMessage For="@(() => _newEmployeeModel.PhoneNumber)" />
		</div>
		</div>

		</div>
		<br />

		<div class="kk-container">
				<h5 style="margin-top: 2px;">Adresse </h5>
				<div class="employee-grouped-inputs">
		<div class="employee-input">
				<label for="streetname-input" class="required">Vejnavn</label>
	<input id="streetname-input" type="text" @bind="_newEmployeeModel.StreetName" />
	<ValidationMessage For="@(() => _newEmployeeModel.StreetName)" />
		</div>

		<div class="employee-input">
				<label for="street-number-input" class="required">Vejnummer</label>
	<input id="street-number-input" type="number" @bind="_newEmployeeModel.StreetNumber" />
	<ValidationMessage For="@(() => _newEmployeeModel.StreetNumber)" />
		</div>

		<div class="employee-input">
	<label for="floor-input">Etage</label>
				<input id="floor-input" type="number" @bind="_newEmployeeModel.Floor" style="width:50px" />
	<ValidationMessage For="@(() => _newEmployeeModel.Floor)" />
		</div>
		</div>
		
		<div class="employee-grouped-inputs">
		<div class="employee-input">
				<label for="city-name-input" class="required">By</label>
	<input id="city-name-input" type="text" @bind="_newEmployeeModel.CityName"/>
	<ValidationMessage For="@(() => _newEmployeeModel.CityName)" />
		</div>

		<div class="employee-input">
				<label for="zipcode-input" class="required">Postnummer</label>
	<input id="zipcode-input" type="number" @bind="_newEmployeeModel.ZipCode" />
	<ValidationMessage For="@(() => _newEmployeeModel.ZipCode)" />
			</div>
		</div>
		</div>
		</div>


		<div class="inputs-items-container kk-container" sstyle="border-radius: 8px; padding: 10px">

    <h5 style="margin-top: 2px;">Vælg behandlinger</h5>
<div style="height: 300px; overflow-y: scroll;">
	<br />

        <div class="treatments-container"> @* Your container for column layout *@
            @foreach (var treatment in _treatments)
            {
                
                    bool isSelected = SelectedTreatmentIds.Contains(treatment.Id);
                    
                    // 1. Define the full style/class string based on selection status
                    string itemStyle = isSelected 
						? "border: 2px solid #990dff; background-color: #f6e6fc; color: black;" // Purple border, light purple background
                        : "border: 2px solid lightgrey; background-color: white; color: black;"; // Grey border, white background
                
                
                @* 2. This DIV now acts as the clickable, styleable list item *@
                <div @onclick="@(() => ToggleTreatmentSelection(treatment.Id))"

                     class="treatment-item py-2 px-4 mb-2 rounded-lg"
                     style="@(itemStyle); cursor: pointer;"> @* Added cursor: pointer for UX *@
                    
					<div class="d-flex justify-space-between align-items-start" style="width: 100%;">
						<div style="text-align: left;">@treatment.Name</div>
                    <div>
                    @* The Icons for selection status *@
                    @if (isSelected)
                    {
						<CheckedCirle/>
					}
                    else
                    {
						<UncheckedCircle/>
                    }
					</div>
					</div>

					<div class="d-flex align-items-start" style="gap: 15px">
					<div class="d-flex align-items-start" style="gap:5px;">
						<DurationIcon Class="treatment-icon"/> <p class="treatment-text">@treatment.DurationMinutes min</p>
					</div>

					<div class="d-flex align-items-start" style="gap:5px;">
						<p class="treatment-text">@treatment.Price kr</p>

					</div>
							</div>
                </div>
            }
        </div> 

</div>	

		<div>
			Valgt: @SelectedTreatmentIds.Count() behandlinger
		</div>
		</div>
	</div>
	 <div class="btn-wrapper">
            <button class="btn-add" type="submit">Opret</button>
	 </div>
</EditForm>


@code {
	[Parameter, EditorRequired]
	public required EventCallback OnCreate { get; set; }

	[Parameter]
	public NewEmployeeModel _newEmployeeModel { get; set; } = new NewEmployeeModel();

	private string? _errorMessage = null;

	private List<Guid> SelectedTreatmentIds { get; set; } = new List<Guid>();
	private List<TreatmentViewModel> _treatments { get; set; } = new List<TreatmentViewModel>();

	private void SetValues(List<Guid> selectedIds)
	{
		SelectedTreatmentIds = selectedIds;
	}

	protected override async Task OnInitializedAsync()
	{
		_errorMessage = null;
		_newEmployeeModel = new NewEmployeeModel();
		await LoadTreatments();
	}

	private void ToggleTreatmentSelection(Guid treatmentId)
	{
		if (SelectedTreatmentIds.Contains(treatmentId))
		{
			// If it's already selected, remove it
			SelectedTreatmentIds.Remove(treatmentId);
		}
		else
		{
			// If it's not selected, add it
			SelectedTreatmentIds.Add(treatmentId);
		}

		// Tells Blazor to re-render the component to update the checkboxes
		StateHasChanged();
	}

	private async Task HandleCreateEmployee()
	{
		try
		{
			_newEmployeeModel.TreatmentIds = SelectedTreatmentIds;

			if (_newEmployeeModel.MiddleName == string.Empty) _newEmployeeModel.MiddleName = null;

			var command = new CreateEmployeeCommand(
				_newEmployeeModel.FirstName,
				_newEmployeeModel.LastName,
				_newEmployeeModel.Email,
				_newEmployeeModel.PhoneNumber,
				_newEmployeeModel.StreetName,
				_newEmployeeModel.CityName,
				_newEmployeeModel.StreetNumber,
				_newEmployeeModel.ZipCode,
				_newEmployeeModel.TreatmentIds,
				_newEmployeeModel.MiddleName,
				_newEmployeeModel.Floor
			);

            await _employeeCommand.CreateEmployeeCommand(command);

			await OnCreate.InvokeAsync();

		}
		catch (Exception e)
		{
			_errorMessage = $"Oprettelse mislykkedes: {e.Message}";
		}
	}

	private async Task LoadTreatments()
	{
		try
		{
			var treatments = await _treatmentQuery.GetAllAsync();
			_treatments = treatments
				.OrderBy(t => t.Name)
				.Select(t => new TreatmentViewModel(t.Id, t.Name, t.Price, t.Duration))
				.ToList();
		}
		catch (Exception ex)
		{
			_errorMessage = $"Der skete en fejl under indlæsning af behandlinger: {ex.Message}";
		}
	}

}
