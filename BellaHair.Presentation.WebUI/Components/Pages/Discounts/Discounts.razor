<!-- Dennis -->

@attribute [StreamRendering]

@page "/rabatter"

@using BellaHair.Domain
@using BellaHair.Ports.Discounts
@using BellaHair.Presentation.WebUI.Components.Shared

@rendermode InteractiveServer

@inject ILoyaltyDiscountQuery _loyaltyDiscountQuery

<PageHeader HeaderText="Rabatter" HeaderSubText="Administrer og tilføj rabatter" NewButtonText="Ny rabat" OnNewButtonClicked="@(() => { })"/>

<div>
	<button @onclick="HandleLoyaltySelectorClick" class="@(_activeTab == DiscountTab.Loyalty ? "btn-select-active" : "btn-select")">Stamkunderabatter (@LoyaltyCount)</button>
	<button @onclick="HandleCampaignSelectorClick" class="@(_activeTab == DiscountTab.Campaign ? "btn-select-active" : "btn-select")">Kampagnerabatter (@CampaignCount)</button>
</div>

<div class="kk-container">
	@if (_errorMessage != null) { <p>@_errorMessage</p> }
	@if (_discounts == null) { <p>Loading</p> }
	else if (_activeTab == DiscountTab.Loyalty)
	{
		@foreach (var loyaltyDiscount in _discounts.OfType<LoyaltyDiscountViewModel>())
		{
			<LoyaltyDiscountCard LoyaltyDiscount="loyaltyDiscount"/>
		}
	}
	else if (_activeTab == DiscountTab.Campaign)
	{
		@foreach (var campaignDiscount in _discounts.OfType<CampaignDiscountViewModel>())
		{

		}
	}
</div>

@code {
	private enum DiscountTab { Loyalty, Campaign }

	private DiscountTab _activeTab;
	private string? _errorMessage;

	private List<IDiscountViewModel>? _discounts = null;
	private int LoyaltyCount;
	private int CampaignCount;

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		await UpdateCounts();
		await HandleLoyaltySelectorClick();
	}

	private async Task HandleLoyaltySelectorClick()
	{
		try
		{
			var discounts = await _loyaltyDiscountQuery.GetAllAsync();

			_discounts = discounts.Select(d =>
				(IDiscountViewModel)(new LoyaltyDiscountViewModel(d.Id, d.Name, d.MinimumVisits, d.DiscountPercent))).ToList();

			_activeTab = DiscountTab.Loyalty;
		}
		catch (DomainException ex) { _errorMessage = ex.Message; }
		catch (Exception ex) { _errorMessage = ex.Message; } 
		@*TODO: "Noget gik galt. "*@
	}

	private void HandleCampaignSelectorClick()
	{
		_discounts = [];

		_activeTab = DiscountTab.Campaign;
	}

	private async Task UpdateCounts()
	{
		LoyaltyCount = await _loyaltyDiscountQuery.GetCount();
	}
}
