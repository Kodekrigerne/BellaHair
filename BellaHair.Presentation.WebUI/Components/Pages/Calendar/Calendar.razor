@page "/kalender"
@using BellaHair.Domain
@using BellaHair.Ports.Bookings
@using BellaHair.Ports.Employees
@using BellaHair.Presentation.WebUI.Components.Pages.Bookings
@using BellaHair.Presentation.WebUI.Components.Pages.Employees
@using BellaHair.Infrastructure
@using Radzen
@rendermode InteractiveServer
@inject IBookingQuery BookingQuery
@inject IEmployeeQuery EmployeeQuery
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="header-and-employee">
    <div>
        <h3>Kalender</h3>
        <p>Vælg den medarbejder, du vil se kalenderen for.</p>
    </div>
    <div class="top-page-item">
        <RadzenDropDown TValue="Guid" Data="@_employees" TextProperty="Fullname" ValueProperty="Id" @bind-Value="@(_pickedEmployeeId)" Change="@HandlePickedEmployee" />
    </div>
</div>

<Radzen.Blazor.RadzenScheduler @ref="scheduler"
                               Data="@_bookings"
                               TItem="BookingCalendarViewModel"
                               StartProperty="StartDateTime"
                               EndProperty="EndDateTime"
                               @bind-CurrentDate="@currentDate"
                               Style="height: 650px;"
                               TextProperty="AllBookingInfo"
                               AppointmentRender="@OnAppointmentRender"
                               AppointmentSelect="@OnAppointmentSelect"
                               NextText="Næste"
                               PrevText="Tilbage"
                               LoadData="@OnLoadData"
                               Culture="@dkCulture">
    <br />

    <RadzenWeekView StartTime="@(TimeSpan.FromHours(8))"
                    EndTime="@(TimeSpan.FromHours(19))"
                    MinutesPerSlot="30" TimeFormat="HH:mm" HeaderFormat="ddd, MMM d" />

    <RadzenDayView StartTime="@(TimeSpan.FromHours(8))"
                   EndTime="@(TimeSpan.FromHours(19))"
                   MinutesPerSlot="30" TimeFormat="HH:mm" />

    <RadzenMonthView />

</Radzen.Blazor.RadzenScheduler>

@code {
    System.Globalization.CultureInfo dkCulture = new System.Globalization.CultureInfo("da-DK") { DateTimeFormat = { ShortDatePattern = "d. MMMM yyyy" } };
    RadzenScheduler<BookingCalendarViewModel> scheduler;

    public List<BookingCalendarViewModel> _bookings { get; set; } = new List<BookingCalendarViewModel>();
    public List<EmployeeNameViewModel> _employees { get; set; } = new List<EmployeeNameViewModel>();

    public DateTime currentDate = DateTime.Today;
    public Guid _pickedEmployeeId { get; set; }

    // --- URL PARAMETERS ---
    [SupplyParameterFromQuery(Name = "date")]
    public DateTime? UrlDate { get; set; }

    [SupplyParameterFromQuery(Name = "employeeId")]
    public Guid? UrlEmployeeId { get; set; }

    protected async override Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    // 1. READ URL (Runs on page load and Back button)
    protected override async Task OnParametersSetAsync()
    {
        // Restore Employee
        if (UrlEmployeeId.HasValue && _employees.Any(e => e.Id == UrlEmployeeId.Value))
        {
            _pickedEmployeeId = UrlEmployeeId.Value;
        }
        else if (_pickedEmployeeId == Guid.Empty && _employees.Any())
        {
            _pickedEmployeeId = _employees.First().Id;
        }

        // Restore Date (Only if different to avoid loop)
        if (UrlDate.HasValue && UrlDate.Value.Date != currentDate.Date)
        {
            currentDate = UrlDate.Value;
        }
    }

    // 2. LOAD DATA & WRITE URL
    private async Task OnLoadData(SchedulerLoadDataEventArgs args)
    {
        // A. Load the data
        if (_pickedEmployeeId != Guid.Empty)
        {
            await LoadBookings(args.Start, args.End, _pickedEmployeeId);
        }

        // B. Update URL Silently (This fixes the exception!)
        // We use JavaScript to change the URL text without stopping the code.
        var dateStr = args.Start.ToString("yyyy-MM-dd");
        var newUrl = $"/kalender?date={dateStr}&employeeId={_pickedEmployeeId}";

        try
        {
            // This line updates the address bar but DOES NOT trigger a reload or exception
            await JSRuntime.InvokeVoidAsync("window.history.replaceState", null, "", newUrl);
        }
        catch { /* Ignore */ }
    }

    private async Task HandlePickedEmployee(object value)
    {
        if (scheduler != null) await scheduler.Reload();
    }

    private async Task LoadEmployees()
    {
        try
        {
            var employees = await EmployeeQuery.GetAllEmployeesSimpleAsync();
            _employees = employees.Select(e => new EmployeeNameViewModel(e.Id, e.Name)).OrderBy(e => e.FullName).ToList();
        }
        catch (Exception e) { Snackbar.Add($"Fejl: {e.Message}", Severity.Error); }
    }

    private async Task LoadBookings(DateTime start, DateTime end, Guid empId)
    {
        try
        {
            var bookings = await BookingQuery.GetAllWithinPeriodOnEmployee(start, end, empId);

            _bookings = bookings.Select(b => new BookingCalendarViewModel(
                b.Id, b.StartDateTime, b.EndDateTime,
                DateOnly.FromDateTime(b.StartDateTime), TimeOnly.FromDateTime(b.StartDateTime), TimeOnly.FromDateTime(b.EndDateTime),
                b.EmployeeFullName, b.CustomerFullName, b.TreatmentName, b.DurationMinutes,
                $"{b.CustomerFullName}\n{b.TreatmentName}\n({b.EmployeeFullName})"
            )).OrderBy(b => b.StartDateTime).ToList();
        }
        catch (Exception) { }
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<BookingCalendarViewModel> args)
    {
        args.Attributes["style"] = "background-color: #eb8ac7; border-color: #eb8ac7; color: white; border-radius: 4px; white-space: pre-wrap;";
    }

    private void OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<BookingCalendarViewModel> args)
    {
        NavigationManager.NavigateTo($"/booking/{args.Data.Id}");
    }
}